# ValutaTrade Hub

## Описание проекта

ValutaTrade Hub — это комплексная платформа для отслеживания и симуляции торговли валютами. Система позволяет пользователям регистрироваться, управлять своим виртуальным портфелем фиатных и криптовалют, совершать сделки по покупке/продаже, а также отслеживать актуальные курсы в реальном времени.

Проект состоит из двух основных сервисов:

1. **Parser Service** — отдельное приложение, которое по запросу обращается к публичным API (CoinGecko для криптовалют, ExchangeRate-API для фиатных валют), получает актуальные курсы, сравнивает их с предыдущими значениями и сохраняет историю в базу данных.

2. **Core Service** — главное приложение, которое предоставляет пользовательский интерфейс (CLI), управляет пользователями, их кошельками, историей транзакций и взаимодействует с сервисом парсинга для получения актуальных курсов.

## Структура каталогов

```
finalproject_sasmsonov_m25_555/
│
├── data/
│   ├── users.json              # список пользователей
│   ├── portfolios.json         # портфели и кошельки
│   ├── rates.json              # кэш текущих курсов валют
│   └── exchange_rates.json     # история всех обновлений курсов
│
├── logs/
│   ├── actions.log             # лог операций пользователей
│   └── valutatrade_hub.log     # общий лог приложения
│
├── valutatrade_hub/
│   ├── __init__.py
│   ├── logging_config.py       # настройка логирования
│   ├── decorators.py           # декораторы (@log_action)
│   │
│   ├── core/
│   │   ├── __init__.py
│   │   ├── models.py           # классы User, Wallet, Portfolio
│   │   ├── currencies.py       # классы Currency, FiatCurrency, CryptoCurrency
│   │   ├── exceptions.py       # пользовательские исключения
│   │   ├── usecases.py        # бизнес-логика (buy, sell, get-rate)
│   │   └── utils.py            # вспомогательные функции
│   │
│   ├── infra/
│   │   ├── __init__.py
│   │   ├── settings.py         # Singleton SettingsLoader (конфигурация)
│   │   └── database.py         # Singleton DatabaseManager (работа с JSON)
│   │
│   ├── parser_service/
│   │   ├── __init__.py
│   │   ├── config.py           # конфигурация API и параметров обновления
│   │   ├── api_clients.py      # работа с внешними API
│   │   ├── updater.py          # основной модуль обновления курсов
│   │   └── storage.py          # операции чтения/записи exchange_rates.json
│   │
│   └── cli/
│       ├── __init__.py
│       └── interface.py        # команды CLI
│
├── main.py                     # точка входа приложения
├── Makefile                    # автоматизация команд
├── pyproject.toml             # конфигурация Poetry
├── poetry.lock                # зафиксированные версии зависимостей
├── api_key.txt                # API-ключ для ExchangeRate-API (не коммитится)
└── README.md                  # этот файл
```

## Установка

Для установки проекта используйте команду:

```bash
make install
```

Эта команда выполнит `poetry install`, которая установит все необходимые зависимости, указанные в `pyproject.toml`.

### Требования

- Python 3.12 или выше
- Poetry (система управления зависимостями)

## Запуск

После установки запустите приложение одной из команд:

```bash
make project
```

или

```bash
poetry run project
```

Обе команды запускают главный цикл CLI, который позволяет взаимодействовать с системой через консольные команды.

## Команды CLI

### Регистрация и вход

**Регистрация нового пользователя:**
```bash
> register --username alice --password 1234
Пользователь 'alice' зарегистрирован (id=3). Войдите: login --username alice --password ****
```

**Вход в систему:**
```bash
> login --username alice --password 1234
Вы вошли как 'alice'
```

### Просмотр портфеля

**Показать портфель (базовая валюта USD по умолчанию):**
```bash
> show-portfolio
Портфель пользователя 'alice' (база: USD):
- USD: 150.00  → 150.00 USD
- BTC: 0.0500  → 2965.00 USD
- EUR: 200.00  → 214.00 USD
---------------------------------
ИТОГО: 3,329.00 USD
```

**Показать портфель с другой базовой валютой:**
```bash
> show-portfolio --base EUR
Портфель пользователя 'alice' (база: EUR):
- USD: 150.00  → 139.05 EUR
- BTC: 0.0500  → 2749.30 EUR
- EUR: 200.00  → 200.00 EUR
---------------------------------
ИТОГО: 3,088.35 EUR
```

### Покупка и продажа валюты

**Покупка валюты:**
```bash
> buy --currency BTC --amount 0.05
Покупка выполнена: 0.0500 BTC по курсу 59300.00 USD/BTC
Изменения в портфеле:
- BTC: было 0.0000 → стало 0.0500
- USD: было 3000.00 → стало 35.00
Оценочная стоимость покупки: 2,965.00 USD
```

**Продажа валюты:**
```bash
> sell --currency BTC --amount 0.01
Продажа выполнена: 0.0100 BTC по курсу 59800.00 USD/BTC
Изменения в портфеле:
- BTC: было 0.0500 → стало 0.0400
- USD: было 35.00 → стало 633.00
Оценочная выручка: 598.00 USD
```

### Получение курсов валют

**Получить курс одной валюты к другой:**
```bash
> get-rate --from USD --to BTC
Курс USD→BTC: 0.00001685 (обновлено: 2025-10-09 00:03:22)
Обратный курс BTC→USD: 59337.21
```

**Показать все доступные курсы:**
```bash
> show-rates
Rates from cache (updated at 2025-10-10T15:30:00):
- BTC_USD: 59337.21
- ETH_USD: 3720.00
- EUR_USD: 1.0786
- GBP_USD: 1.2623
- RUB_USD: 0.01016
```

**Показать курсы для конкретной валюты:**
```bash
> show-rates --currency BTC
Rates from cache (updated at 2025-10-10T15:30:00):
- BTC_USD: 59337.21
```

**Показать топ N самых дорогих криптовалют:**
```bash
> show-rates --top 2
Rates from cache (updated at 2025-10-10T15:30:00):
- BTC_USD: 59337.21
- ETH_USD: 3720.00
```

### Обновление курсов

**Обновить все курсы валют:**
```bash
> update-rates
INFO: Starting rates update...
INFO: Fetching from CoinGecko... OK (3 rates)
INFO: Fetching from ExchangeRate-API... OK (3 rates)
INFO: Writing 6 rates to data/rates.json...
Update successful. Total rates updated: 6. Last refresh: 2025-10-10T15:30:00
```

**Обновить курсы только из одного источника:**
```bash
> update-rates --source coingecko
INFO: Starting rates update...
INFO: Fetching from CoinGecko... OK (3 rates)
Update successful. Total rates updated: 3. Last refresh: 2025-10-10T15:30:00
```

## Кэш и TTL (Time To Live)

Система использует кэширование курсов валют для повышения производительности и снижения нагрузки на внешние API.

### Формат кэша

Курсы хранятся в файле `data/rates.json` в следующем формате:

```json
{
  "pairs": {
    "EUR_USD": {
      "rate": 1.0786,
      "updated_at": "2025-10-10T12:00:00Z",
      "source": "ExchangeRate-API"
    },
    "BTC_USD": {
      "rate": 59337.21,
      "updated_at": "2025-10-10T12:00:00Z",
      "source": "CoinGecko"
    }
  },
  "last_refresh": "2025-10-10T12:00:01Z"
}
```

### TTL (время жизни кэша)

По умолчанию TTL для курсов валют составляет **3600 секунд (1 час)**. Это значение можно настроить в `pyproject.toml`:

```toml
[tool.valutatrade]
rates_ttl_seconds = 3600  # 1 час
```

### Поведение при устаревших данных

Если курс в кэше старше TTL, система:
- Предупреждает пользователя о том, что данные могут быть устарели
- Предлагает выполнить команду `update-rates` для обновления курсов
- Продолжает использовать устаревшие данные, если обновление недоступно

### История обновлений

Все обновления курсов сохраняются в файл `data/exchange_rates.json` для последующего анализа и построения графиков динамики курсов.

## Parser Service

Parser Service — это отдельный модуль, отвечающий за получение актуальных курсов валют из внешних API.

### Включение Parser Service

Parser Service автоматически включен и доступен через команды CLI:
- `update-rates` — запускает обновление курсов
- `show-rates` — показывает курсы из кэша

### Источники данных

1. **CoinGecko** — для криптовалют (BTC, ETH, SOL и др.)
   - Не требует API-ключа
   - Бесплатный доступ с ограничениями по частоте запросов

2. **ExchangeRate-API** — для фиатных валют (EUR, GBP, RUB и др.)
   - Требует API-ключа
   - Бесплатный план доступен на [exchangerate-api.com](https://www.exchangerate-api.com/)

### Хранение API-ключа

API-ключ для ExchangeRate-API хранится в файле `api_key.txt` в корне проекта:

```
[ваш ключ]
```

**Важно:**
- Файл `api_key.txt` добавлен в `.gitignore` и не коммитится в репозиторий
- Для использования другого ключа просто замените содержимое файла `api_key.txt`
- Альтернативно, можно использовать переменную окружения `EXCHANGERATE_API_KEY`

### Настройка API-ключа

1. Получите бесплатный API-ключ на [exchangerate-api.com](https://www.exchangerate-api.com/)
2. Создайте файл `api_key.txt` в корне проекта
3. Вставьте ваш API-ключ в файл (одна строка, без пробелов)

Пример:
```bash
echo "ваш_api_ключ_здесь" > api_key.txt
```

### Использование переменной окружения

Вместо файла можно использовать переменную окружения:

```bash
export EXCHANGERATE_API_KEY="ваш_api_ключ_здесь"
poetry run project
```

Если установлена переменная окружения, она имеет приоритет над файлом `api_key.txt`.
